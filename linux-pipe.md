---
title: 管道内部的组织方式
date: 2016-07-14 00:05:24
categories: Linux
tags: Linux系统篇
---
一、管道
	管道是一种两个进程间进行单向通信的机制。因为管道传递数据的单向性，管道又称为半双工管道。管道的这一特点决定了其使用的局限性。管道是Linux支持的最初Unix IPC形式之一，具有以下特点：
	1)数据只能由一个进程流向另一个进程（其中一个读管道，一个写管道）；如果要进行双工通信，需要建立两个管道。
	2)管道只能用于父子进程或者兄弟进程间通信。，也就是说管道只能用于具有亲缘关系的进程间通信。
	除了以上局限性，管道还有其他一些不足，如管道没有名字（匿名管道），管道的缓冲区大小是受限制的。管道所传输的是无格式的字节流。这就需要管道输入方和输出方事先约定好数据格式。虽然有那么多不足，但对于一些简单的进程间通信，管道还是完全可以胜任的。
	使用管道进行通信时，两端的进程向管道读写数据是通过创建管道时，系统设置的文件描述符进行的。从本质上说，管道也是一种文件，但它又和一般的文件有所不同，可以克服使用文件进行通信的两个问题，这个文件只存在内存中。
	通过管道通信的两个进程，一个进程向管道写数据，另外一个从中读数据。写入的数据每次都添加到管道缓冲区的末尾，读数据的时候都是从缓冲区的头部读出数据的。

二、管道的容量
在讨论管道内部的组织结构之前我们可以先来测试一下管道的容量：
测试管道容量的代码如下：

	  1 #include<unistd.h>
	  2 #include<stdio.h>
	  3 #include<errno.h>
	  4 #include<sys/types.h>
	  5 #include<sys/wait.h>
	  6 #include<string.h>
	  7 
	  8 int main()
	  9 {
	 10     int pipe_fd[2];
	 11     if(pipe(pipe_fd) < 0)
	 12     {
	 13         perror("pipe");
	 14         return -1;
	 15     }
	 16 
	 17     int ret;
	 18     int count = 0;
	 19     while(1)
	 20     {
	 21         ret = write(pipe_fd[1], "A", 1);
	 22         if(ret < -1)
	 23         {
	 24             perror("write");
	 25             return -1;
	 26         }
	 27         count++;
	 28         printf("pipe capacity:%d\n",count);
	 29     }
	 30     return 0;
	 31 }
测试结果如图所示：
![1](http://o6lb63nu0.bkt.clouddn.com/pipe_01.png)

三、管道的内部组织方式
实际上pipe并没有单独的实现数据结构，他利用了文件的在 Linux 中，而是借助了文件系统的file结构和VFS的索引节点inode。通过将两个 file 结构指向同一个临时的 VFS 索引节点，而这个 VFS 索引节点又指向一个物理页面而实现的。有两个 file 数据结构，但它们定义文件操作例程地址是不同的，其中一个是向管道中写入数据的例程地址，而另一个是从管道中读出数据的例程地址。这样，用户程序的系统调用仍然是通常的文件操作，而内核却利用这种抽象机制实现了管道这一特殊操作。

PS：VFS（virtual File System）的作用就是采用标准的Unix系统调用读写位于不同物理介质上的不同文件系统,即为各类文件系统提供了一个统一的操作界面和应用编程接口。VFS是一个可以让open()、read()、write()等系统调用不用关心底层的存储介质和文件系统类型就可以工作的粘合层。
