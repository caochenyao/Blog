---
title: atexit()函数
date: 2016-06-15 11:05:14
categories: Linux
tags: Linux系统篇
---
一、atexit()函数
函数名：atexit
头文件：#include<stdlib.h>
用法：int atexit(void (*func)(void))
注意：按照ISO C的规定，一个进程可以登记多达32个函数，这些函数将由exit自动调用通常这32个函数被称为终止处理程序，并调用atexit函数来登记这些函数，atexit函数被称为终止处理程序注册程序。atexit注册的函数类型应为不接受任何参数void函数，exit调用这些注册函数的顺序与他们登记时候的顺序相反。同一个函数若被登记多次，则也会被调用多次。其中，atexit的参数是一个函数地址。
如图例子：
![1](http://o6lb63nu0.bkt.clouddn.com/atexit_1.png)
执行结果如下图：
![2](http://o6lb63nu0.bkt.clouddn.com/atexit_2.png)
根据exit的执行过此可知，exit首先会调用各个终止处理程序，然后按需多次调用fclose(),关闭所有打开流，也就是说exit函数会执行一个标准I/O库的清理关闭操作：对所有打开的流调用fclose()，这样就会造成所有缓冲的输出数据都被冲洗即写入文件中。

内核使程序执行的唯一方法是调用一个exec函数，进程自愿终止的唯一方法是显式或者隐式调用(通过exit函数)_exit()或者_Exit()函数。因此exit函数中实质是对_exit()或者_Exit()函数的封装。exit会先执行自定义的终止处理函数，然后执行I/O库函数清理函数fclose(),这也是为什么可以在终止处理函数中可以继续运用printf之类函数的原因，因为I/O库函数的流对象还没有被清除，当然可以继续运用。执行完了所有的fclose()以后，可以执行真正意义上的终止函数_exit()或者_Exit()函数。

既然这里用到了exit函数，那么我们接下来就来了解一下exit函数
二、exit函数
要了解exit，首先就要知道exit函数的功能，exit函数是来终止进程的。
那么首先来说说进程的终止。
1.Linux中进程的终止
进程就好比人一样有其生命，我们通过fork()函数来创建一个进程，那么我们又是如何来中止进程呢。 
进程退出表示进程即将结束。在Linux中进程退出分为了正常退出和异常退出两种。 
1)正常退出 
a. 在main()函数中执行return 。 
b.调用exit()函数 
c.调用_exit()函数 
2)异常退出 
a.调用about函数 
b.进程收到某个信号，而该信号使程序终止。
不管是哪种退出方式，系统最终都会执行内核中的同一代码。这段代码用来关闭进程所用已打开的文件描述符，释放它所占用的内存和其他资源。
2.exit函数和_exit函数
1)exit和_exit函数都是用来终止进程的。 
当程序执行到exit或_exit时，系统无条件的停止剩下所有操作，清除包括PCB在内的各种数据结构，并终止本进程的运行。
2)exit在头文件stdlib.h中声明，而_exit()声明在头文件unistd.h中声明。 exit中的参数exit_code为０代表进程正常终止，若为其他值表示程序执行过程中有错误发生。
3)exit()和_exit()的区别： 
a._exit()执行后立即返回给内核，而exit()要先执行一些清除操作，然后将控制权交给内核。
b. 调用_exit函数时，其会关闭进程所有的文件描述符，清理内存以及其他一些内核清理函数，但不会刷新流(stdin, stdout, stderr ...). exit函数是在_exit函数之上的一个封装，其会调用_exit，并在调用之前先刷新流。 

exit()函数与_exit()函数最大区别就在于exit()函数在调用exit系统之前要检查文件的打开情况，把文件缓冲区的内容写回文件。由于Linux的标准函数库中，有一种被称作“缓冲I/O”的操作，其特征就是对应每一个打开的文件，在内存中都有一片缓冲区。每次读文件时，会连续的读出若干条记录，这样在下次读文件时就可以直接从内存的缓冲区读取；同样，每次写文件的时候也仅仅是写入内存的缓冲区，等满足了一定的条件（如达到了一定数量或遇到特定字符等），再将缓冲区中的内容一次性写入文件。这种技术大大增加了文件读写的速度，但也给编程代来了一点儿麻烦。比如有一些数据，认为已经写入了文件，实际上因为没有满足特定的条件，它们还只是保存在缓冲区内，这时用_exit()函数直接将进程关闭，缓冲区的数据就会丢失。因此，要想保证数据的完整性，就一定要使用exit()函数。
举个例子进行说明：
1）使用exit函数终止进程：

	  1 #include<stdio.h>
	  2 #include<stdlib.h>
	  3 
	  4 int main()
	  5 {
	  6     printf("exit\n");
	  7     printf("Hello World");
	  8 
	  9     exit(0);
	 10 }
 ![3](http://o6lb63nu0.bkt.clouddn.com/atexit_3.png)
2)使用_exit函数终止进程：

	  1 #include<stdio.h>
	  2 #include<unistd.h>
	  3 
	  4 int main()
	  5 {
	  6     printf("_exit\n");
	  7     printf("Hello World");
	  8 
	  9     _exit(0);
	 10 } 
 ![4](http://o6lb63nu0.bkt.clouddn.com/atexit_4.png)
在之前的博客中我们已经提到过printf刷新缓冲区的问题，这两个例子可以很明显的看出exit函数会检查文件的打开情况，将缓冲区的内容写回文件，而_exit函数则会直接关闭进程，可能导致缓冲区数据的丢失。                                                                          